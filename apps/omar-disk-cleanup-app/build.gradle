apply plugin: 'groovy'
apply plugin: 'maven'
buildscript {
  ext {
    baseImage = "omar-base"
    dockerStatementsOverride = {[
        "FROM ${project.dockerNamespaceUrl}${project.ext.baseImage}:${project.dockerAppTag}",
        "MAINTAINER DigitalGlobe-RadiantBlue",
        "COPY ${project.name}-${buildVersion}-${buildVersionTag}.jar /home/omar",
        """RUN yum install -y chronie && \
            yum install -y initscripts && \
            yum clean all && \
            echo "*/10 * * * * . \$HOME/.profile; java -jar /home/omar/disk-cleanup/disk-cleanup.jar >> /dev/null 2>&1" > crontab.txt && \
            crontab crontab.txt
        """,
        """CMD echo "export JAVA_HOME=\$JAVA_HOME" >> \$HOME/.profile && \
            echo "export JDBC_CONNECTION_STRING=\$JDBC_CONNECTION_STRING" >> \$HOME/.profile && \
            echo "export O2_DISK_VOLUME=/$O2_DISK_VOLUME" >> \$HOME/.profile && \
            echo "export O2_MAX_DISK_LIMIT=/$O2_MAX_DISK_LIMIT" >> \$HOME/.profile && \
            echo "export O2_MIN_DISK_LIMIT=/$O2_MIN_DISK_LIMIT" >> \$HOME/.profile && \
            echo "export POSTGRES_PASSWORD=/$POSTGRES_PASSWORD" >> \$HOME/.profile && \
            echo "export POSTGRES_USER=/${POSTGRES_USER" >> \$HOME/.profile && \
            echo "export STAGER_URL=/$STAGER_URL" >> \$HOME/.profile && \
            crond -p;"""
    ]}
  }
  if(System.env.OMAR_COMMON_PROPERTIES)
  {
    apply from: System.env.OMAR_COMMON_PROPERTIES
  }
  repositories {
    mavenLocal()
    maven { url "${ossimMavenProxy}" }
  }
}
apply plugin: "java"
apply plugin: "maven-publish"
apply plugin: "maven"

group "io.ossim.omar.apps"

repositories {
  mavenLocal()
  maven { url "${ossimMavenProxy}" }
  mavenCentral()
}

dependencies {
  compile 'org.codehaus.groovy:groovy-all:2.4.7'
  compile 'org.codehaus.groovy.modules.http-builder:http-builder:0.7.1'
  compile 'org.postgresql:postgresql:9.4-1205-jdbc42'
}

jar {
  from { configurations.compile.collect { it.isDirectory() ? it : zipTree(it) } }

  manifest {
    attributes 'Main-Class': "diskCleanup"
  }
}

publishing {
  publications {
    mavenJava(MavenPublication) {
      from components.java
    }
  }
}
